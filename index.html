<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Chat UI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f7f8;
      --panel:#ffffff;
      --border:#e7e7ea;
      --text:#111114;
      --muted:#6b6f76;
      --bubble:#ffffff;
      --bubble2:#f2f2f4;
      --radius:16px;
      --radius2:14px;
      --focus:0 0 0 3px rgba(16, 120, 255, .25);
      --danger:#b42318;
      --ok:#027a48;
      --btn:#111114;
      --btnText:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Lato", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .app{height:100%;display:flex;flex-direction:column}
    .topbar{
      height:56px;display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;background:var(--panel);border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:5;
    }
    .brand{display:flex;gap:10px;align-items:center;min-width:0}
    .logo{
      width:28px;height:28px;border-radius:8px;background:#111114;
      display:inline-flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;font-size:14px;flex:0 0 auto;
    }
    .titlewrap{min-width:0}
    .title{font-weight:900;font-size:15px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .subtitle{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions{display:flex;align-items:center;gap:8px;flex:0 0 auto}
    .btn{
      border:1px solid var(--border);background:var(--panel);color:var(--text);
      padding:8px 10px;border-radius:12px;font-weight:700;font-size:13px;cursor:pointer;line-height:1;
    }
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{background:var(--btn);color:var(--btnText);border-color:transparent}
    .btn.danger{color:var(--danger)}
    .main{
      flex:1 1 auto;display:flex;justify-content:center;padding:14px 12px 0;overflow:hidden;
    }
    .chatShell{
      width:min(920px, 100%);height:100%;display:flex;flex-direction:column;gap:0;
    }
    .feed{flex:1 1 auto;overflow:auto;padding:14px 2px 18px;scroll-behavior:smooth}
    .row{display:flex;padding:8px 0}
    .row.user{justify-content:flex-end}
    .row.assistant{justify-content:flex-start}
    .bubble{
      max-width:min(720px, 92%);border-radius:var(--radius);
      padding:12px 14px;border:1px solid rgba(0,0,0,0.04);
      background:var(--bubble);line-height:1.45;font-size:15px;
      white-space:pre-wrap;word-wrap:break-word;
    }
    .row.user .bubble{background:var(--bubble2);border-color:rgba(0,0,0,0.03)}
    .meta{margin-top:6px;display:flex;align-items:center;gap:10px;font-size:12px;color:var(--muted)}
    .chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;
      border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted);user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--danger)}
    .composerWrap{
      position:sticky;bottom:0;background:linear-gradient(to top, var(--bg) 70%, rgba(247,247,248,0));
      padding:12px 0 12px;z-index:4;
    }
    .composer{
      width:min(920px, 100%);margin:0 auto;
      background:var(--panel);border:1px solid var(--border);border-radius:22px;
      padding:10px 10px;display:flex;gap:10px;align-items:flex-end;
      box-shadow:0 12px 26px rgba(16,24,40,.10);
    }
    .inputWrap{flex:1 1 auto;position:relative}
    textarea{
      width:100%;min-height:44px;max-height:160px;resize:none;
      border:0;outline:none;background:transparent;color:var(--text);
      font-family:"Lato", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size:15px;line-height:1.4;padding:8px 104px 8px 10px;
    }
    textarea::placeholder{color:#8a8f98}
    .langSelect{
      position:absolute;right:8px;top:8px;
      height:30px;max-width:140px;
      border:1px solid var(--border);background:var(--panel);color:var(--text);
      border-radius:999px;padding:0 10px;font-weight:700;font-size:12px;
      cursor:pointer;
    }
    .langSelect:focus{outline:none;box-shadow:var(--focus)}
    .sendBtn{
      flex:0 0 auto;height:44px;min-width:88px;border-radius:16px;
      border:0;cursor:pointer;font-weight:900;font-size:14px;
      background:var(--btn);color:var(--btnText);
      display:flex;align-items:center;justify-content:center;
    }
    .sendBtn:focus{outline:none;box-shadow:var(--focus)}
    .sendBtn[disabled]{opacity:.55;cursor:not-allowed}
    .hint{
      width:min(920px, 100%);margin:10px auto 0;
      color:var(--muted);font-size:12px;padding:0 4px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .kbd{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;border:1px solid var(--border);border-bottom-width:2px;
      padding:2px 6px;border-radius:8px;background:var(--panel);color:var(--muted);
    }
    @media (max-width:520px){
      .sendBtn{min-width:72px}
      textarea{padding-right:96px}
      .langSelect{max-width:122px}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">G</div>
        <div class="titlewrap">
          <div class="title">Chat</div>
          <div class="subtitle" id="subStatus">Local demo (no backend)</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnExport">Export</button>
        <button class="btn danger" id="btnClear">Clear</button>
      </div>
    </div>

    <div class="main">
      <div class="chatShell">
        <div class="feed" id="feed" aria-live="polite" aria-label="Chat messages"></div>

        <div class="composerWrap">
          <div class="composer" role="group" aria-label="Message composer">
            <div class="inputWrap">
              <textarea id="input" rows="1" placeholder="Message..." autocomplete="off" autocapitalize="sentences" spellcheck="true"></textarea>
              <select id="lang" class="langSelect" title="Language">
                <!-- Common ChatGPT-supported languages (UI list). Add/remove freely. -->
                <option value="en" selected>English</option>
                <option value="es">Español</option>
                <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="it">Italiano</option>
                <option value="pt">Português</option>
                <option value="nl">Nederlands</option>
                <option value="sv">Svenska</option>
                <option value="no">Norsk</option>
                <option value="da">Dansk</option>
                <option value="fi">Suomi</option>
                <option value="pl">Polski</option>
                <option value="cs">Čeština</option>
                <option value="sk">Slovenčina</option>
                <option value="hu">Magyar</option>
                <option value="ro">Română</option>
                <option value="bg">Български</option>
                <option value="uk">Українська</option>
                <option value="ru">Русский</option>
                <option value="tr">Türkçe</option>
                <option value="el">Ελληνικά</option>
                <option value="he">עברית</option>
                <option value="ar">العربية</option>
                <option value="fa">فارسی</option>
                <option value="hi">हिन्दी</option>
                <option value="bn">বাংলা</option>
                <option value="ur">اردو</option>
                <option value="ta">தமிழ்</option>
                <option value="te">తెలుగు</option>
                <option value="ml">മലയാളം</option>
                <option value="mr">मराठी</option>
                <option value="gu">ગુજરાતી</option>
                <option value="pa">ਪੰਜਾਬੀ</option>
                <option value="th">ไทย</option>
                <option value="vi">Tiếng Việt</option>
                <option value="id">Bahasa Indonesia</option>
                <option value="ms">Bahasa Melayu</option>
                <option value="fil">Filipino</option>
                <option value="sw">Kiswahili</option>
                <option value="zh-Hans">中文（简体）</option>
                <option value="zh-Hant">中文（繁體）</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
              </select>
            </div>
            <button class="sendBtn" id="send">Send</button>
          </div>

          <div class="hint">
            <div>Enter to send, <span class="kbd">Shift</span> + <span class="kbd">Enter</span> for newline</div>
            <div id="translateState" class="chip"><span class="dot ok"></span><span>Translation: Auto</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Local Chat UI + Language Translation
    // - No backend: assistant replies are placeholder.
    // - Language dropdown translates all existing messages and sets future input/assistant to that language.
    // - Uses browser's built-in translation when available:
    //     1) Web Translation API (if present)
    //     2) Google Translate "unofficial" endpoint (network required)
    // If translation fails, it gracefully falls back to original text.
    // -----------------------------

    const feed = document.getElementById("feed");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const langSel = document.getElementById("lang");
    const subStatus = document.getElementById("subStatus");
    const translateState = document.getElementById("translateState");
    const btnClear = document.getElementById("btnClear");
    const btnExport = document.getElementById("btnExport");

    // Message store keeps canonical text in original (as entered) plus per-language cached translations.
    // Each message: { role: 'user'|'assistant', originalLang: 'en', originalText: '...', translations: { [langCode]: '...' }, ts: number }
    let messages = [];
    let currentLang = langSel.value; // UI language selection
    let lastLang = currentLang;

    function nowTs(){ return Date.now(); }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function autoGrow(){
      input.style.height = "0px";
      input.style.height = Math.min(input.scrollHeight, 160) + "px";
    }

    function scrollToBottom(){
      feed.scrollTop = feed.scrollHeight + 999999;
    }

    function setTranslateIndicator(ok, text){
      const dot = translateState.querySelector(".dot");
      dot.classList.remove("ok","bad");
      dot.classList.add(ok ? "ok" : "bad");
      translateState.lastChild.textContent = text;
    }

    function render(){
      feed.innerHTML = "";
      for (const m of messages){
        const row = document.createElement("div");
        row.className = "row " + (m.role === "user" ? "user" : "assistant");

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        const displayText = getDisplayText(m, currentLang);
        bubble.innerHTML = escapeHtml(displayText);

        row.appendChild(bubble);
        feed.appendChild(row);
      }
      scrollToBottom();
    }

    function getDisplayText(message, lang){
      if (lang === message.originalLang) return message.originalText;
      if (message.translations && message.translations[lang]) return message.translations[lang];
      return message.originalText;
    }

    function addMessage(role, text, lang){
      messages.push({
        role,
        originalLang: lang,
        originalText: text,
        translations: {},
        ts: nowTs()
      });
      render();
      persist();
    }

    function persist(){
      try{
        localStorage.setItem("simple_chat_messages", JSON.stringify(messages));
        localStorage.setItem("simple_chat_lang", currentLang);
      }catch(e){}
    }

    function restore(){
      try{
        const m = localStorage.getItem("simple_chat_messages");
        const l = localStorage.getItem("simple_chat_lang");
        if (l) {
          currentLang = l;
          langSel.value = l;
        }
        if (m){
          messages = JSON.parse(m) || [];
        }
      }catch(e){}
      render();
    }

    // Basic assistant placeholder (local-only). Replace this with your API call if desired.
    function localAssistantReply(userText){
      const base = "I’m a simple local demo UI. Hook this up to your ChatGPT-compatible endpoint to get real answers.\n\nYou said:\n" + userText;
      return base;
    }

    async function sendMessage(){
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";
      autoGrow();

      sendBtn.disabled = true;
      addMessage("user", text, currentLang);

      // Placeholder assistant response in same selected language.
      const reply = localAssistantReply(text);
      addMessage("assistant", reply, "en"); // store assistant canonical in English (placeholder)
      // If UI language isn't English, translate assistant message immediately for display.
      await translateAllTo(currentLang);

      sendBtn.disabled = false;
      input.focus();
    }

    // Translation engines

    // Attempt Web Translation API (not widely available yet), else fallback to Google endpoint.
    async function translateText(text, fromLang, toLang){
      if (!text) return text;
      if (fromLang === toLang) return text;

      // 1) Web Translation API (if available)
      try{
        if (window.translation && typeof window.translation.createTranslator === "function"){
          const translator = await window.translation.createTranslator({ sourceLanguage: fromLang, targetLanguage: toLang });
          const out = await translator.translate(text);
          if (out) return out;
        }
      }catch(e){}

      // 2) Fallback: Google translate endpoint (network required)
      // Note: This is a pragmatic fallback for a drop-in HTML demo.
      // If blocked by CORS in some environments, it will fail and we fall back to original.
      try{
        const url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=" +
          encodeURIComponent(fromLang) + "&tl=" + encodeURIComponent(toLang) + "&dt=t&q=" + encodeURIComponent(text);

        const res = await fetch(url, { method:"GET" });
        if (!res.ok) throw new Error("translate_http_" + res.status);
        const data = await res.json();
        // data[0] is array of translated segments
        const translated = (data && data[0] && Array.isArray(data[0]))
          ? data[0].map(seg => seg && seg[0] ? seg[0] : "").join("")
          : "";
        return translated || text;
      }catch(e){
        return text;
      }
    }

    async function translateMessageIfNeeded(m, targetLang){
      if (!m || !targetLang) return;
      if (m.translations && m.translations[targetLang]) return;

      const fromLang = m.originalLang || "en";
      const baseText = m.originalText || "";
      const translated = await translateText(baseText, fromLang, targetLang);

      m.translations = m.translations || {};
      m.translations[targetLang] = translated || baseText;
    }

    async function translateAllTo(targetLang){
      if (!targetLang) return;

      setTranslateIndicator(true, "Translation: Working...");
      subStatus.textContent = "Translating conversation...";

      // Translate sequentially to reduce rate spikes and keep UI stable.
      for (const m of messages){
        // If message is already in target language, no work needed.
        if ((m.originalLang || "en") === targetLang) continue;
        await translateMessageIfNeeded(m, targetLang);
        render();
      }

      setTranslateIndicator(true, "Translation: Auto");
      subStatus.textContent = "Local demo (no backend)";
      persist();
    }

    // Events
    input.addEventListener("input", autoGrow);

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener("click", sendMessage);

    langSel.addEventListener("change", async () => {
      const next = langSel.value;
      lastLang = currentLang;
      currentLang = next;
      persist();
      await translateAllTo(currentLang);
    });

    btnClear.addEventListener("click", () => {
      messages = [];
      persist();
      render();
    });

    btnExport.addEventListener("click", () => {
      const payload = {
        exportedAt: new Date().toISOString(),
        currentLang,
        messages
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "chat_export.json";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    });

    // Boot
    restore();
    autoGrow();

    // If there are existing messages and the selected language isn't their originals, translate on load.
    (async () => {
      if (messages.length){
        await translateAllTo(currentLang);
      }
    })();
  </script>
</body>
</html>
